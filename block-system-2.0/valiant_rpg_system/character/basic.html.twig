{% import _self as sheet %}
{% set sheetname = 'valiant' %}
{% set abilities = [ "Strength", "Dexterity", "Constitution", "Intelligence", "Wisdom", "Charisma" ] %}
{% set spell_abilities = [ ["NONE","NONE"], ["INT","Intelligence"], ["WIS", "Wisdom"], ["CHA", "Charisma"], ["CON", "Constitution"] ] %}
{% set xp_list = [ 0, 300, 900, 2700, 6500, 14000, 23000, 34000, 48000, 64000, 85000, 100000, 120000, 140000, 165000, 195000, 225000, 265000, 305000, 355000, 355000, 385000, 415000, 445000, 475000, 505000, 535000, 565000, 595000, 625000, 655000 ] %}
{% set skill_list = [ ["Acrobatics","dexterity"],["Animal Handling","wisdom"],["Arcana","intelligence"],["Athletics","strength"],["Deception","charisma"],["History","intelligence"],["Insight","wisdom"],["Intimidation","charisma"],["Investigation","intelligence"],["Medicine","wisdom"],["Nature","intelligence"],["Perception","wisdom"],["Performance","charisma"],["Persuasion","charisma"],["Religion","intelligence"],["Sleight of Hand","dexterity"],["Stealth","dexterity"],["Survival","wisdom"] ] %}
{# --- calculate level --- #}
{% set level = 0 %}
{% if variables.level_1|default > 0 %}{% set level = level + variables.level_1 %}{% endif %}
{% if variables.level_2|default > 0 %}{% set level = level + variables.level_2 %}{% endif %}
{% if variables.level_3|default > 0 %}{% set level = level + variables.level_3 %}{% endif %}
{% if variables.level_4|default > 0 %}{% set level = level + variables.level_4 %}{% endif %}
{% if level < 1 %}{% set level = 1 %}{% endif %}
{# --- grab the level if and of the four is a bard #}
{% set blevel = 0 %}
{% if 'bard' in variables.class_1|default|lower %}{% set blevel = variables.level_1|default('0') %}{% endif %}
{% if 'bard' in variables.class_2|default|lower %}{% set blevel = variables.level_2|default('0') %}{% endif %}
{% if 'bard' in variables.class_3|default|lower %}{% set blevel = variables.level_3|default('0') %}{% endif %}
{% if 'bard' in variables.class_4|default|lower %}{% set blevel = variables.level_4|default('0') %}{% endif %}
{# jack of all trades #}
{% set joat = variables.jack_of_all_trades|default %}
{# attributes #}
{% set constitution = variables.constitution|default(10) %}
{% set dexterity = variables.dexterity|default(10) %}
{% set strength = variables.strength|default(10) %}
{% set intelligence = variables.intelligence|default(10) %}
{% set wisdom = variables.wisdom|default(10) %}
{% set charisma = variables.charisma|default(10) %}
{% set con_bonus = ((constitution - 10) // 2) %}
{% set dex_bonus = ((dexterity - 10) // 2) %}
{% set str_bonus = ((strength - 10) // 2) %}
{% set ini_mod = variables.initiative_mod|default %}
{% if ini_mod == 0 %}{% set ini_mod = 0 %}{% endif %}{# possible replacement of "" to 0 #}
{% set ini = variables.initiative|default %}
{# fix for older sheets that had ini instead if ini_mod #}
{% if ini != "" %}
    {% set ini_mod = ini - dex_bonus %}
    {% set ini = "" %}
{% endif %}
{# --- AC --- #}
{% set armor_class = 10 + dex_bonus %}{% set ac_txt = "10 + DEX Bonus (" ~ dex_bonus ~ ")" %}
{% set armor_name = 'none' %}
{% set shield_class = 0 %}
{% set shield_name = 'none' %}
{% set clistmax = 12 %}
{% for i in 1..clistmax %}
	{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
	{% set name = attribute(variables, 'armor_name_' ~ id)|default|trim %}
	{% if name != "" %}
		{% set aac = attribute(variables, 'armor_ac_' ~ id)|default|trim %}
		{% set worn = attribute(variables, 'armor_worn_' ~ id)|default|trim %}
		{% set shield = attribute(variables, 'armor_shield_' ~ id)|default|trim %}
		{% set dexmod = attribute(variables, 'armor_dexmod_' ~ id)|default|trim %}
		{% if worn == 1 %}
			{% if shield == 1 %}
				{% set shield_name = name %}
				{% set shield_class = aac %}
			{% else %}
				{% set armor_name = name %}
				{% set armor_class = aac %}{% set ac_txt = aac %}
				{% if dexmod != 0 %}
					{% set armor_class = armor_class + dexmod %}
					{% set ac_txt = ac_txt ~ " + DEX Bonus (" ~ dexmod ~ ")" %}
				{% endif %}
			{% endif %}
		{% endif %}
	{% endif %}
{% endfor %}
{% set armor_class_mod = variables.armor_class_mod|default != '' %}
{% if variables.armor_class_mod != '' %}
	{% set armor_class = armor_class + armor_class_mod %}
	{% set ac_txt = ac_txt ~ " + AC Mod. (" ~ armor_class_mod ~ ")" %}
{% endif %}
{% set shield_class = armor_class + shield_class %}
{# --- HIT POINTS --- #}
{% set chp = variables.hit_points_current|default %}
{% if variables.hit_points is defined and variables.hit_points != '' %}
	{# if the player/dm has entered hitpoints, use them #}
	{% set hp = variables.hit_points %}
    {% if chp == '' %}{% set chp = hp %}{% endif %}
{% else %}
	{# if the hp field is empty, automatically calculate them #}
	{% set cb = ((variables.constitution|default('10') - 10) / 2)|round(0, 'floor') %}
	{% set hp = cb + variables.hit_die_1|default('8') %}
	{% if level > 1 %}
		{% for i in 2..level %}
			{% set die = attribute(variables, 'hit_die_' ~ i)|default('8') / 2 %}
			{% set die = die+0.5|round(0, 'ceil') %}
			{% set hp = hp + cb + die %}
		{% endfor %}
	{% endif %}
{% endif %}
{% if chp == '' %}{% set chp = hp %}{% endif %}
{% if chp > hp %}{% set chp = hp %}{% endif %}
{# --- PROF BONUS + XP required for next level --- #}
{% set xpreq = 0 %}
{% set l = level %}
{% set pb = (1 + l / 4)|round(0, 'ceil') %}
{% set pbd = '' %}
{% set prof_dice_enabled = 0 %}
{% if variables.prof_dice_enabled is defined and variables.prof_dice_enabled == 1 %}
	{% set prof_dice_enabled = 1 %}
	{% set pbd = 'd4' %}
	{% if level >  4 %}{% set pbd = 'd6' %}{% endif %}
	{% if level >  8 %}{% set pbd = 'd8' %}{% endif %}
	{% if level > 12 %}{% set pbd = 'd10' %}{% endif %}
	{% if level > 16 %}{% set pbd = 'd12' %}{% endif %}
{% endif %}
{% set xpreq = xp_list[l]|default(0) %}
{# --- SPELLCASTING --- #}
{% set sca = variables.spellcasting_ability|default %}
{% if sca != "NONE" %}
    {% set scm = attribute(variables, sca|lower) %}
    {% set scm_mod = variables.scm_mod|default %}
	{% if scm_mod == ''%}{% set scm_mod = 0 %}{% endif %}
	{% set scm = ((scm - 10) // 2) + scm_mod %}
	{% set ssdc = 8 + pb + scm %}
	{% if prof_dice_enabled == 1 %}
		{% if scm > -1 %}{% set scm = '+' ~ scm %}{% endif %}	
		{% set sam = pbd ~ scm %}
	{% else %}
		{% set sam = pb + scm %}
	{% endif %}
{% endif %}
{#
sca:	spellcasting ability (= wis, int, con, or cha)
scm:	spellcasting modifier (derived from sca, -4 to +4) + any additional bonus from feats, items etc
sam:	spell attack modifier (scm + proficiency)
#}
{# ---------------------------------------------- #}
{% macro getMod( abi, add = '', pbd = '') %}
{% set mod = 0 %}
{% if abi is defined and abi != '' %}
	{% set mod = (abi - 10) // 2 %}
{% endif %}
{% if pbd != '' %}
	{% if add is defined and add != '' %}
		{% if mod > -1 %}{% set mod = '+' ~ mod %}{% endif %}
		{% set mod = mod ~ '+' ~ add %}
	{% endif %}
{% else %}
	{% if add is defined and add != '' %}
		{% set mod = mod + add %}
	{% endif %}
	{% if mod > -1 %}{% set mod = '+' ~ mod %}{% endif %}
{% endif %}
{{mod}}{% endmacro getMod %}
{# ---------------------------------------------- #}
{% macro addSign( abi, roll = 'y', pbd = '' ) %}
{% if pbd != '' %}
	{% set result = abi %}
	{% if result != '' %}{% set result = result|replace({'+0': ""}) %}{% endif %}
{% else %}
	{% if abi > 0 %} {% set result = '+' ~ abi %} {% elseif abi == '' or abi == 0 %} {% set result = '+0' %}{% else %} {% set result =  abi %} {% endif %}
{% endif %}
{% set rc = '+' ~ result %}{% set rc = rc|replace({'++': "+", '+-': "-"}) %}
{% if result != '' %}{% set result = result|replace({'++': "+", '+-': "-"}) %}{% endif %}
{% if roll == 'y' %}[roll:1d20{{ rc }}|{{ result }}]{% else %}{{ result }}{% endif %}
{% endmacro addSign %}
{# ---------------------------------------------- #}
{% macro skillRoll( bonus = 0, abi = 0, default = 10, prof = 0, exp = 0, pb = 0, pbd = '', jack = 0, blevel = 0) %}
{% if abi == 0 or abi == '' or abi < 0 %}{% set abi = default %}{% endif %}
{% if abi > 0 %}{% set bonus = bonus|number_format + (abi|number_format - 10) // 2 %}{% endif %}
{% set disbonus = '' %}
{% if pbd != '' %}
	{% if bonus > -1 %}{% set bonus = '+' ~ bonus %}{% endif %}
	{% if exp is defined and exp == '1' %}{% set bonus = bonus ~ '+2' ~ pbd %}
	{% elseif prof is defined and prof == '1' %}{% set bonus = bonus ~ '+' ~ pbd %}
	{% elseif jack is defined and jack == '1' and blevel > 1 %}
		{% set disbonus = bonus ~ '+' ~ pbd ~ '/2' %}
		{% set bonus = bonus ~ '+round(' ~ pbd ~ '/2)' %}
	{% endif %}
{% else %}
	{% if exp is defined and exp == '1' %}{% set bonus = bonus + 2 * pb %}
	{% elseif prof is defined and prof == '1' %}{% set bonus = bonus + pb %}
	{% elseif jack is defined and jack == '1' and blevel > 1 %}{% set bonus = bonus + pb // 2 %}{% endif %}
	{% if bonus > -1 %}{% set bonus = '+' ~ bonus %}{% endif %}
{% endif %}
{% if bonus != '' %}
	{% set bonus = bonus|replace({' ':"", '	':"", '\xc2\xa0':""}) %}
	{% set bonus = bonus|replace({'+0+':"+", '+0-':"-", '++':"+", '+-':"-"}) %}
{% endif %}
{% if disbonus == '' %}{% set disbonus = bonus %}{% else %}
	{% set disbonus = disbonus|replace({' ':"", '	':"", '\xc2\xa0':""}) %}
	{% set disbonus = disbonus|replace({'+0+':"+", '+0-':"-", '++':"+", '+-':"-"}) %}
{% endif %}
<span title="Roll: 1d20{{bonus}}">[roll:1d20{{bonus}}|{{disbonus}}]</span>
{% endmacro skillRoll %}
{# ---------------------------------------------- #}
{% macro abiModifier( abi = 10, dice = '20', show = false ) %}
	{% if abi is defined %}
		{% if abi == '' %}{% set abi = 10 %}{% endif %}
		{% set mod = (abi - 10) // 2 %}
		{% if mod > -1 %}{% set mod = '+' ~ mod %}{% endif %}
		{% if show == false %}
			[roll:1d{{dice}}{{ mod }}|{{ mod }}]
		{% else %}
			[roll:1d{{dice}}{{ mod }}|1d{{dice}}{{ mod }}]
		{% endif %}
	{% else %}[roll:1d20|+0]{% endif %}
{% endmacro abiModifier %}
{# ---------------------------------------------- #}
{% macro mark( prof, exp, pb, jack, blevel ) %}
{% if exp is defined and exp == '1' %}
	<em class="fas fa-diamond" title="includes expertise bonus (2x proficiency bonus/die)"></em>
{% elseif prof is defined and prof == '1' %}
	<em class="fas fa-circle" title="includes proficiency bonus/die"></em>
{% else %}
	{% set j = pb / 2 %}{% set j = j|round(0, 'floor') %}
	{% if jack is defined and jack == '1' and blevel > 1 and j > 0 %}
	<em class="fal fa-scrubber" title="jack of all trades: includes half proficiency bonus/die"></em>
	{% else %}
	<em class="fal fa-circle" title="not proficient"></em>
	{% endif %}
{% endif %}
{% endmacro mark %}
{# ---------------------------------------------- #}
{% macro attack(eo, id, prof = 0, name, abiname, mod1, dmg, dmgt, props, pb, pbd, mod2 = 0, worn = 0) %}{% if name is defined and name != '' %}
{% set dmgtitle = "" %}{% set abiname = abiname|upper %}{% set col = '' %}{% if worn == 0 %}{% set col = 'faded' %}{% endif %}
{% if mod2 > 0 %}
    {% set dmgmod2 = (mod2 - 10) / 2 %}{% set dmgmod2 = dmgmod2|round(0, 'floor') %}
    {% set mod2 = (mod2 - 10) / 2 %}{% set mod2 = mod2|round(0, 'floor') %}
	{% if dmg != "" %}
		{% if dmgmod2 > 0 %}
			{% if abiname[:3] == "STR" or abiname[:3] == "DEX" %}
				{% set dmg = dmg ~ '+' ~ dmgmod2 %}
				{% set dmgtitle = "+" ~ dmgmod2 ~ " " ~ abiname[:3] ~ " MOD" %}
			{% endif %}
		{% elseif dmgmod2 < 0 %}
			{% if abiname[:3] == "STR" or abiname[:3] == "DEX" %}
				{% set dmg = dmg ~ dmgmod2 %}
				{% set dmgtitle = dmgmod2 ~ " " ~ abiname[:3] ~ " MOD" %}
			{% endif %}
		{% endif %}
	{% endif %}
{% else %}
    {% set mod2 = 0 %}
{% endif %}
{% set mod = (mod1|number_format) + (mod2|number_format) %}
<tr>
<td class="{{eo}} {{col}} c">
{% if worn == 1 %}
	<em class="fa-regular fa-hand-fist" title="item worn/equipped"></em>
{% else %}
	<em class="fa-thin fa-backpack {{col}}" title="item not worn/equipped"></em>
{% endif %}
</td><td class="pb {{eo}} {{col}} c">
{% if prof == 1 %}
	{% if mod > -1 %}{% set mod = '+'~mod %}{% endif %}
	{% if pbd != '' %}
		{% if prof is defined and prof == '1' %}{% set mod = mod ~ '+' ~ pbd %}{% endif %}
		<em class="fas fa-circle {{col}}" title="includes +{{pbd}} proficiency die"></em>
	{% else %}
		{% if prof is defined and prof == '1' %}{% set mod = mod + pb %}{% endif %}
		{% if mod > -1 %}{% set mod = '+'~mod %}{% endif %}
		<em class="fas fa-circle {{col}}" title="includes +{{pb}} proficiency bonus"></em>
	{% endif %}
{% else %}
	{% if mod > -1 %}{% set mod = '+'~mod %}{% endif %}
	<em class="fal fa-circle {{col}}" title="not proficient"></em>
{% endif %}</td>
    <td class="{{eo}} {{col}}">{{name}}</td>{% set xmod = mod %}{% if mod == '+0' %}{% set mod = '' %}{% endif %}
    <td class="{{eo}} {{col}} c" title="1d20{{mod}}">[roll:1d20{{mod}}|{{xmod}}]</td>  
    <td class="{{eo}} {{col}} c">{{abiname[:3]}}</td>
    <td class="{{eo}} {{col}} c" title="{{dmgtitle}}">[roll:{{dmg}}]</td>
    <td class="{{eo}} {{col}} c">{{dmgt}}</td>
</tr>{% if props is defined and props != '' %}<tr><td colspan=2 class="{{eo}} {{col}}">&nbsp;</td><td colspan=5 class="{{eo}} {{col}}">{{props}}</td></tr>{% endif %}{% endif %}{% endmacro attack %}
{# ---------------------------------------------- #}
{% macro armor(eo, id, name, ac, props, worn = 0, shield = 0, adddex = 0, dex_bonus = 0) %}<tr>
    <td class="{{eo}} c">
	{% set col = '' %}
	{% if worn == 1 %}
		<em class="fa-regular fa-hand-fist" title="item worn/equipped"></em>
	{% else %}
		{% set col = 'faded' %}
		<em class="fa-thin fa-backpack {{col}}" title="item not worn/equipped"></em>
	{% endif %}
	</td>
    <td class="{{eo}} {{col}} c">
		{% if shield == 1 %}<em class="fa-sharp fa-solid fa-shield {{col}}" title="is shield"></em>{% else %}&nbsp;{% endif %}
	</td>
    <td class="{{eo}} {{col}} l">{{name}}</td>
    <td class="{{eo}} {{col}} c">{{ac}}</td>
    <td class="{{eo}} {{col}} c">
		{% if adddex == 1 %}<em class="fas fa-circle {{col}}" title="add DEX Bonus"></em>{% else %}<em class="fal fa-circle {{col}}" title="no DEX Bonus added"></em>{% endif %}
	</td>
    <td class="{{eo}} {{col}} l">{{props}}</td>
</tr>{% endmacro armor %}
{# ---------------------------------------------- #}
{% macro spell(id, counter = 0, spell_ring = '', spell_name = '', spell_id = '', spell_ability = '', scm = '', pb = '', pbd = '', spell_prepared = 0, spell_casting_time = '', spell_range = '', spell_duration = '', spell_damage = '', spell_damage_scm = "", spell_damage_higher = '', spell_damage_scaled = '', spell_components = '', spell_component_sets = '', spell_notes = '') %}{% if spell_prepared == 1 %}
<tr>{% set eo = "od" %}{% if counter is even %}{% set eo = "ev" %}{% endif %}{% set spell_ability = spell_ability|upper %}
{% if scm > 0 %}
	{% set scm = (scm - 10) / 2 %}{% set scm = scm|round(0, 'floor') %}
	{% set scm = scm|replace({'+0': ""}) %}
	{% if scm > 0 %}{% set scm = '+' ~ scm %}{% endif %}
	{% set sam = '' %}
	{% if pbd != '' %}
		{% set sam = '+' ~ pbd ~ scm %}
		{% set lbl = 'dice' %}
	{% else %}
		{% set sam = pb + scm %}
		{% if sam > 0 %}{% set sam = '+' ~ sam %}{% endif %}
		{% set lbl = 'bonus' %}
	{% endif %}
	{% if spell_damage != "" and spell_damage != "-" %}
		{% if spell_damage_scm > 0 %}{% set spell_damage = spell_damage ~ scm %}{% endif %}
	{% endif %}
{% endif %}
	{% set txt = "" %}
	{% if spell_damage_scaled == "" %}
		{% set rolldamage = spell_damage %}
	{% else %}
		{% set rolldamage = spell_damage ~ spell_damage_scaled %}
		{% set txt = "*" %}
	{% endif %}
    <td class="{{eo}} lg">
	<span title="Name of the spell">{% if spell_id > 0 %} [blocklink:{{spell_id}}] {% else %}{{spell_name}}{% endif %}</span>
	{% if txt !="" %}<font title="Scaled up"><i class="fas fa-arrow-alt-circle-up"></i></font>{% endif %}
	</td>
    <td class="{{eo}} c" title="Spell Attack"><span title="Roll: 1d20 + {{spell_ability}} mod + prof {{lbl}}">[roll:1d20{{sam}}|{{sam}}]</span></td>
    <td class="{{eo}} c" title="Casting time">{{ spell_casting_time }}</td>
    <td class="{{eo}} c" title="Range">{{ spell_range }}</td>
    <td class="{{eo}} c" title="Duration">{{ spell_duration }}</td>
	<td class="{{eo}} c" title="Damage or healing power: {{rolldamage}}">{% if spell_damage != "" and spell_damage != "-" %}[roll:{{rolldamage}}|{{spell_damage}}] {% if txt !="" %}+ <font title="Scaled up: {{spell_damage_scaled}}"><i class="fas fa-arrow-alt-circle-up"></i></font>{% endif %} {% endif %}</td>
    <td class="{{eo}} c" title="Required components (verbal, somatic, material)">{{ spell_components }}</td>
    <td class="{{eo}} c" title="Components for how many casts available">{{ spell_component_sets }}</td>
</tr>{% if spell_notes != "" %}<tr><td colspan=1 class="{{eo}}">&nbsp;</td><td colspan=1 class="{{eo}} r">Notes:</th><td colspan=10 class="{{eo}}">{{ spell_notes }}</td></tr>{% endif %}
{% endif %}{% endmacro spell %}
{# ---------------------------------------------- #}
{# --- sheet -- #}
<div class="{{sheetname}}-sheet">
    <!-- Header -->
	<button title="Minimize header section" class="minimize btn btn-link collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#collapsePersonal" href="#collapsePersonal" role="button" aria-expanded="true" aria-controls="collapsePersonal"><em class="fas fa-angle-down"></em></button>
	<div class="row collapse show" id="collapsePersonal">
		{% if variables.imageid|default > 0 %}
		<div class="col-12 col-md-12 col-lg-8">
		{% else %}
		<div class="col-12 col-md-12 col-lg-12">
		{% endif %}
			<div class="row">
				<div class="col-12">
					<div class="card my-2 logo noborder hidden-md hidden-xs hidden-sm d-none d-lg-block" title="Tales of the Valiant Logo"></div>
				</div>
			</div>
			<div class="row">
				<div class="col-12 col-md-6 col-lg-6">
					<h1 class="{{sheetname}}-sheet-header">{{ variables.name|default }}</h1>
					<span class="inputContent">{{ level|default('1') }}</span>
					<span class="inputLabel">Level ({{variables.xp|default('0') }}/{{xpreq|default('?') }} XP for level-up)</span>
					<span class="inputContent">{{ variables.lineage|default }}</span>
					<span class="inputLabel">Lineage</span>
					<span class="inputContent">{{ variables.heritage|default }}</span>
					<span class="inputLabel">Heritage</span>
					<span class="inputContent">{{ variables.background|default }}</span>
					<span class="inputLabel">Background</span>
					<span class="inputContent">{{ variables.homeland|default }}</span>
					<span class="inputLabel">Homeland</span>
				</div>
				<div class="col-12 col-md-6">
					<div class="row">
						{% for i in 1..4 %}
						<div class="col-6 col-xs-6 col-sm-3 col-md-6 col-lg-6">
							{% if attribute(variables, 'class_' ~ i)|default != '' %}
							<div class="contentContainer contentContainer-attribute of lh">
								<span class="inputContent lh emp">{{ attribute(variables, 'class_' ~ i)|default }}</span><br>
								{% if attribute(variables, 'subclass_' ~ i)|default != "" %}<span class="inputContent lh">{{ attribute(variables, 'subclass_' ~ i)|default }}</span><br>{% endif %}
								<span class="inputContent lh">Level {{ attribute(variables, 'level_' ~ i)|default }}</span><br>
								{% set hd = attribute(variables, 'level_' ~ i)|default %}{% set hd1 = variables.hit_dice_remaining|default %}{% if hd1 != "" %}{% set hd = hd1 %}{% endif %}
								<span class="inputContent lh">Hit Dice: {{hd}}/{{ attribute(variables, 'level_' ~ i)|default('1') }}</span><br>
								<span title="The Hit die + bonus, eg 1d8+2">{{ sheet.abiModifier( constitution, attribute(variables, 'hit_die_' ~ i)|default, true ) }}</span>
								<span class="inputLabel">Class {{i}}</span>
							</div>
							{% endif %}
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		{% if variables.imageid|default > 0 %}
		<div class="col-12 col-xs-12 col-md-6 col-lg-4 hidden-xs hidden-sm hidden-md d-none d-lg-block">
			[img:{{variables.imageid}}]
		</div>
		{% endif %}
	</div>
	<hr>
	<div class="row">
        {% for a in abilities %}
		<div class="col-6 col-xs-6 col-sm-4 col-md-2 col-lg-2">
			<div class="contentContainer contentContainer-attribute lh">
				<span title="{{a}}">{{a[:3]|upper}} {{ attribute(variables, a|lower) }}</span><br>
				<span class="attmod strong lh">{{ sheet.abiModifier( attribute(variables, a|lower) ) }}</span>
				<small>Save: {{ sheet.mark( attribute(variables, a|lower ~ '_save_prof')|default, 0, pb ) }} {{ sheet.skillRoll( attribute(variables, a|lower ~ '_save_mod')|default, attribute(variables, a|lower)|default, 10, attribute(variables, a|lower ~ '_save_prof')|default, 0, pb, pbd, 0 ) }}</small>
			</div>
		</div>
        {% endfor %}
	</div>
	<div class="row">
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">
				{% if variables.initiative_score|default > 0 %}
					{{ 10 + dex_bonus + ini_mod }}
					</span><br>
					<span class="inputLabel">Initiative Score</span>
				{% else %}
					{{ sheet.addSign( dex_bonus|number_format + ini_mod|number_format ) }}
					</span><br>
					<span class="inputLabel">Initiative (DEX)</span>
				{% endif %}
			</div>
		</div>
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">{{ variables.speed|default(30) }}</span><br>
				<span class="inputLabel" title="Speed in ft">Speed (walk/run/fly)</span>
			</div>
		</div>
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">
					{% for i in 1..5 %}
						{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
						{% if attribute(variables, 'luck_' ~ id)|default|default == 1 %}<i class='fa-solid fa-circle'></i>{% else %}<i class='fa-regular fa-circle'></i>{% endif %}
					{% endfor %}
				</span><br>
				<span class="inputLabel">Luck</span>
			</div>
		</div>
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">{{ variables.status|default }}</span><br>
				<span class="inputLabel">Status</span>
			</div>
		</div>
		<div class="col-12 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="inputLabel">Hit Points</span>
				<span class="strong">{{ hp }}</span><br>
				<span class="inputLabel c">Death Saves</span>
				<div class="row">
					<div class="col-6">
						<span class="strong">
							{% for i in 1..3 %}
								{% if attribute(variables, 'dss' ~ i)|default|default == 1 %}<i class='fa-solid fa-circle'></i>{% else %}<i class='fa-regular fa-circle'></i>{% endif %}
							{% endfor %}
						</span>
						<span class="inputLabel">Succeeded</span>
					</div>
					<div class="col-6">
						<span class="strong">
							{% for i in 1..3 %}
								{% if attribute(variables, 'dsf' ~ i)|default|default == 1 %}<i class='fa-solid fa-circle'></i>{% else %}<i class='fa-regular fa-circle'></i>{% endif %}
							{% endfor %}
						</span><br>
						<span class="inputLabel">Failed</span>
					</div>
				</div>
			</div>
		</div>
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">
					{% for i in 1..6 %}
						{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
						{% if attribute(variables, 'exhaustion_' ~ id)|default|default == 1 %}<i class='fa-solid fa-circle'></i>{% else %}<i class='fa-regular fa-circle'></i>{% endif %}
					{% endfor %}
				</span><br>
				<span class="inputLabel">Exhaustion</span>
			</div>
		</div>
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong" title='{{ac_txt}}'>{{ armor_class }}</span>{% if armor_name != '' and armor_name != 'none' %}<br>{{ armor_name }}{% endif %}
				<span class="inputLabel">Armor Class (AC)</span>
			</div>
		</div>
    	{% if shield_name != '' and shield_name != 'none' %}
		<div class="col-6 col-xs-6 col-sm-4 col-md-3">
			<div class="contentContainer contentContainer-attribute of">
				<span class="strong">{{ shield_class }}</span><br>{{ shield_name }}
				<span class="inputLabel">Armor Class w/Shield</span>
			</div>
		</div>
		{% endif %}
		{% for i in 1..9 %}
			{% if i == 1 %}
				{% set label = variables.class_resource_label|default %}
				{% set res = variables.class_resource|default %}
				{% set curr = variables.class_resource_curr|default(res) %}
			{% else %}
				{% set label = attribute(variables, 'class_resource_label_' ~ i)|default %}
				{% set res = attribute(variables, 'class_resource_' ~ i)|default %}
				{% set curr = attribute(variables, 'class_resource_curr_' ~ i)|default(res) %}
			{% endif %}
			{% if label != '' %}
				<div class="col-6 col-xs-6 col-sm-4 col-md-3">
					<div class="contentContainer contentContainer-attribute of">
						<span class="strong">{{curr}} / {{res}}</span><br>
						<span class="inputLabel">{{label}}</span>
					</div>  
				</div>
			{% endif %}
		{% endfor %}
		{% if sca|upper != "NONE" %}
		<div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-6">
			<div class="contentContainer contentContainer-attribute c">
				<span class="inputLabel">Spellcasting ...
					{% if variables.spell_points_max|default > 0 %}
						(Points: <span class="strong">{{ variables.spell_points_curr|default(variables.spell_points_max) }}/{{ variables.spell_points_max }} )</span>
					{% endif %}
				</span>
				<div class="row">
					<div class="col-12 col-sm-3 col-lg-3 c">
						<span class="strong">{{ sheet.addSign(sam, 'y', pbd) }}</span>
						<span class="inputLabel" title="Spell Attack Modifier">Attack mod</span>
					</div>
					<div class="col-12 col-sm-3 col-lg-3 c">
						{{sca[:3]|upper}}
						<span class="inputLabel" title="Spell Ability">Ability</span>
					</div>
					<div class="col-12 col-sm-3 col-lg-3 c">
						+{{scm}}
						<span class="inputLabel" title="Spell Ability Modifier">Abi Mod</span>
					</div>
					<div class="col-12 col-sm-3 col-lg-3 c">
						{{ssdc}}
						<span class="inputLabel" title="Spell Save DC">Save DC</span>
					</div>
				</div>
			</div>
		</div>
		{% endif %}
	</div>
	<hr>
	<div class="row">
		<div class="col-12">
			<div class="contentContainer contentContainer-side pdl10">
				<table width="100%">
				<tr>
					<td width="30px"><em class="fas fa-diamond"></em></td>
					<td><span class="strong pull-left">
					{% if pbd != '' %}
					{{ sheet.addSign( '2' ~ pbd, '', pbd ) }}
					{% else %}
					{{ sheet.addSign( 2*pb, '' ) }}
					{% endif %} Expertise Bonus</span></td>
					<td width="30px"><em class="fas fa-circle"></em></td>
					<td><span class="strong pull-left">
					{% if pbd != '' %}
					{{ sheet.addSign( pbd, '', pbd ) }}
					{% else %}
					{{ sheet.addSign( pb, '' ) }}
					{% endif %} Proficiency Bonus</span></td>
				{% set j = pb / 2 %}{% set j = j|round(0, 'floor') %}
				{% if joat is defined and joat == 1 and j > 0 %}
					<td width="30px"><em class="fal fa-scrubber"></em></td>
					<td><span class="strong pull-left">
					{% if pbd != '' %}
					{{ sheet.addSign( pbd ~ '/2', '', pbd ) }}
					{% else %}
					{{ sheet.addSign( j, '' ) }}
					{% endif %} Jack of all Trades</span></td>
				</tr>
				{% endif %}
				</table>
			</div>
		</div>
		<div class="col-12 col-md-6">
			<div class="listContainer contentContainer-standard of">
				<table width="100%" class="skilltable">
					<tr>
						<th class="od w30 c" title="proficient (adds prof. bonus)">Pr</th>
						<th class="od w50 c" title="Skill Bonus">Bonus</th>
						<th class="od">Skill</th>
						<th class="od w90 c" title="Ability">Abi</th>
					</tr>
					{% set eo = 'od' %}
					{% for k in skill_list %}
						{% set sk = k[0]|default %}
						{% set skl = sk|lower|replace({' ': '_'}) %}
						{% set ab = k[1]|default %}
						{% set abi = attribute(variables, skl ~ '_abi')|default %}
						{% set sk = k[0]|default %}
						<tr>
							<td class="pb {{eo}} c">{{ sheet.mark( attribute(variables, skl ~ '_prof')|default, attribute(variables, skl ~ '_exp')|default, pb, joat, blevel ) }}</td>
							<td class="{{eo}}">{{ sheet.skillRoll( attribute(variables, skl)|default, attribute(variables, abi)|default, attribute(variables, ab), attribute(variables, skl ~ '_prof')|default, attribute(variables, skl ~ '_exp')|default, pb, pbd, joat, blevel ) }}</td>
							<td class="{{eo}}">{{sk}}</td>
							<td class="{{eo}} c">{{ab[:3]|upper}}</td>
						</tr>
						{% if eo == 'od' %}{% set eo = 'ev' %}{% else %}{% set eo = 'od' %}{% endif %}
					{% endfor %}
				</table>
				<span class="inputLabel">skills</span>
			</div>
		</div>
		<div class="col-12 col-md-6">
			<div class="listContainer contentContainer-standard of">
				<table width="100%" class="skilltable">
					<tr>
						<th class="od w30 c" title="proficient (adds prof. bonus)">Pr</th>
						<th class="od w50 c" title="Skill Bonus">Bonus</th>
						<th class="od">Skill</th>
						<th class="od w90 c" title="Ability">Abi</th>
					</tr>
					{% set clistmax = 50 %}{% set eo = 'od' %}
					{% for i in 1..clistmax %}
						{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
						{% set name = attribute(variables, 'skill_name_' ~ id)|default|trim %}
						{% if name != "" %}
							<tr>
								{% set prof = attribute(variables, "skill_prof_" ~ id)|default %}
								{% set exp = attribute(variables, "skill_exp_" ~ id)|default %}
								{% set abi = attribute(variables, "skill_abi_" ~ id)|default %}
								{% set value = attribute(variables, "skill_value_" ~ id)|default %}
								<td class="pb {{eo}} c">{{ sheet.mark( prof, exp, pb, joat, blevel ) }}</td>
								<td class="{{eo}}">{{ sheet.skillRoll( value, attribute(variables, abi )|default, 10, prof, exp, pb, pbd, joat, blevel ) }}</td>
								<td class="{{eo}}">{{name}}</td>
								<td class="{{eo}} c">{{abi[:03]|upper}}</td>
							</tr>
							{% if eo == 'od' %}{% set eo = 'ev' %}{% else %}{% set eo = 'od' %}{% endif %}
						{% endif %}
					{% endfor %}
				</table>
				<span class="inputLabel">skills</span>
			</div>
			<div class="listContainer contentContainer-standard of">
				<table width="100%">
					<tr>
						<th class="hdr w30 c" title="item worn/equipped">W</th>
						<th class="hdr w30 c" title="proficient (adds prof. bonus)">Pr</th>
						<th class="hdr">Weapon / Attack</th>
						<th class='hdr c' title="Attack Bonus">AB</th>
						<th class='hdr c' title="Ability">Abi</th>
						<th class='hdr c'>Dmg</th>
						<th class='hdr c'>Dmg Type</th>
					</tr>
					{% set clistmax = 40 %}{% set eo = 'od' %}
					{% for i in 1..clistmax %}
						{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
						{% set name = attribute(variables, 'attack_' ~ id)|default|trim %}
						{% if name != "" %}
							{{ sheet.attack(eo, id,
								attribute(variables, 'attack_prof_' ~ id)|default,
								attribute(variables, 'attack_' ~ id)|default,
								attribute(variables, 'attack_abi_' ~ id)|default,
								attribute(variables, 'attack_mod_' ~ id)|default,
								attribute(variables, 'attack_dmg_' ~ id)|default,
								attribute(variables, 'attack_dmg_type_' ~ id)|default,
								attribute(variables, 'attack_props_' ~ id)|default,
								pb, pbd,
								attribute(variables, attribute(variables, 'attack_abi_' ~ id)|default|lower)|default,
								attribute(variables, 'attack_worn_' ~ id)|default,
							) }}
							{% if eo == 'od' %}{% set eo = 'ev' %}{% else %}{% set eo = 'od' %}{% endif %}
						{% endif %}
					{% endfor %}
				</table>
				<span class="inputLabel">Attacks</span>
			</div>
			<div class="listContainer contentContainer-standard of">
				<table width="100%">
					<tr>
						<th class='hdr w30 c' title='item worn/equipped'>W</th>
						<th class='hdr w30 c' title='is shield'>S</th>
						<th class="hdr">&nbsp;Armor</th>
						<th class='hdr c'>Base AC</th>
						<th class='hdr w30 c' title='including DEX Mod.'>D</th>
						<th class="hdr">Properties</th>
					</tr>
					{% set clistmax = 12 %}{% set eo = 'od' %}
					{% for i in 1..clistmax %}
						{% set id = i %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
						{% set name = attribute(variables, 'armor_name_' ~ id)|default|trim %}
						{% if name != "" %}
							{{ sheet.armor(eo, id,
								name,
								attribute(variables, 'armor_ac_' ~ id)|default,
								attribute(variables, 'armor_props_' ~ id)|default,
								attribute(variables, 'armor_worn_' ~ id)|default,
								attribute(variables, 'armor_shield_' ~ id)|default,
								attribute(variables, 'armor_dexmod_' ~ id)|default,
								dex_bonus
							) }}
							{% if eo == 'od' %}{% set eo = 'ev' %}{% else %}{% set eo = 'od' %}{% endif %}
						{% endif %}
					{% endfor %}
				</table>
				<span class="inputLabel">Armor
				{% if armor_class_mod != '' %}
				( AC Mod: {{ sheet.addSign(armor_class_mod, 'n') }} )
				{% endif %}
				</span>
			</div>
		</div>
	</div>
</div>
{% if sca != "NONE" %}
<div class="pagebreak"></div>
<div class="{{sheetname}}-sheet">
	<div class="contentContainer contentContainer-standard pd0">
		<span class="headerContent"><h1 class="pdl10">Spell Book <button title="Click me!" class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseSpells" aria-expanded="true" aria-controls="collapseSpells"><em class="fas fa-book"></em></button></h1></span>
		<div class="row spell-row collapse hide" id="collapseSpells">
			<div class="col-12 col-xs-12" id="{{sheetname}}-spells">
				<!-- Spells -->
				<div class="{{sheetname}}-sheet-container pd0 of">
					<div class="form-group of">
						<table width="100%" class="attacktable" id="spelltable">
							{% for i in 0..9 %}
								{% if i == 0 %}
									{# always show cantrips #}
									{% set sl = "C" %}
									{% set show = 99 %}
									{% set title = "Cantrips" %}
									{% set slots = "" %}
								{% else %}
									{% set sl = i %} {# we are looking for spells matching slot sl #}
									{% set show = attribute (variables, 'total_spell_slots_' ~ i)|default %} {# the total of spell slot entries the user has #}
									{% set title = "Ring " ~ i ~ " Spells" %}
									{% set slots = show ~ " slots" %}
								{% endif %}
								{# only show spells that are cantrips or the user has a total of spell slot entries for them #}
								{% set counter = 1 %} {# start counting at 1 for each spell ring #}
								{% if show > 0 %}
									{# walk through all spell entries #}
									{% for k in 1..60 %}
										{% set id = k %}{% if id < 10 %}{% set id = '0' ~ id %}{% endif %}
										{% set name = attribute(variables, "spell_name_" ~ id)|default %}
										{# do not show spells without a name #}
										{% if name != "" %} 
											{% set t = attribute(variables, "spell_ring_" ~ id)|default|upper %} {# ring of the spell #}
											{% set scales = attribute(variables, "spell_damage_higher_" ~ id)|default %} {# this spell scales? #}
											{# ring matches OR ring is lower (and not a cantrip) and also is a scalable spell #}
											{% if t == sl or ( scales != "" and sl != "C" and t < sl ) %}
												{# add header to each spell ring and then every 10 spells #}
												{% if counter == 1 %}{% set done = 0 %}{% endif %}
												{% if done == 0 %}
													{% set done = 1%}
													<tr><th colspan=9 class="c"><h2>{{title}}{% if slots !="" %} <span class="badge">{{slots}}</span></h2>{% endif %}
													</th></tr>
													<tr>
														<th title="Name of the spell" width="15%" class="pdl10">NAME</th>
														<th title="Spell Attack Bonus" class="w90 c">AB</th>
														<th title="Casting time" class="c">CAST</th>
														<th title="Range" class="c">RNG</th>
														<th title="Duration" class="c">DUR</th>
														<th title="Damage or healing power (rollable)" class="w120 c">DMG</th>
														<th title="Required components (verbal, somatic, material)" class="w90 c">CMP</th>
														<th title="Components for how many casts available" class="w60 c">#</th>
													</tr>
												{% endif %}
												{# set damage depending on matching ring or scaled up spell #}
												{% set scale_dmg = "" %}
												{% if t < sl %}
												 	{# spell is scaled up #}
													{% set scale_dmg = '' %}{# attribute(variables, "spell_damage_" ~ id) #}
													{% for l in 1..(sl - t) %}{% set scale_dmg = scale_dmg ~ '+' ~ scales %}{% endfor %}
												{% endif %}
												{{ sheet.spell( id, counter,
													sl,
													attribute(variables, "spell_name_" ~ id)|default,
													attribute(variables, "spell_id_" ~ id)|default,
													attribute(variables, "spell_ability_" ~ id )|default,
													attribute(variables, attribute(variables, "spell_ability_" ~ id )|default|lower )|default,
													pb,
													pbd,
													attribute(variables, "spell_prepared_" ~ id)|default,
													attribute(variables, "spell_casting_time_" ~ id)|default,
													attribute(variables, "spell_range_" ~ id)|default,
													attribute(variables, "spell_duration_" ~ id)|default,
													attribute(variables, "spell_damage_" ~ id)|default,
													attribute(variables, "spell_damage_scm_" ~ id)|default,
													attribute(variables, "spell_damage_higher" ~ id)|default,
													scale_dmg,
													attribute(variables, "spell_components_" ~ id)|default,
													attribute(variables, "spell_component_sets_" ~ id)|default,
													attribute(variables, "spell_notes_" ~ id|default)
												) }}
												{% set counter = counter + 1 %}
											{% endif %}
										{% endif %}
									{% endfor %}
								{% endif %}
							{% endfor %}
						</table>
					</div>                  
				</div>
			</div>
		</div>
	</div>
</div>
{% endif %}
<div class="pagebreak"></div>
<div class="{{sheetname}}-sheet">
	<div class="row">
		<div class="col-12 col-md-12 col-lg-6">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.equipment|default|nl2br }}</div><br>
				<span class="inputLabel">Treasure and Equipment</span>
				<span class="inputContent">Copper: {{ variables.copper_pieces ?? 0 }}, </span>
				<span class="inputContent">Silver: {{ variables.silver_pieces ?? 0 }}, </span>
				<span class="inputContent">Gold: {{ variables.gold_pieces ?? 0 }}, </span>
				<span class="inputContent">Platinum: {{ variables.platinum_pieces ?? 0 }}</span>
				<span class="inputLabel">Money</span>
			</div>
		</div>
		{% if variables.proficiencies_and_languages|default != "" %}
		<div class="col-12 col-md-12 col-lg-6 of">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.proficiencies_and_languages|nl2br }}</div><br>
				<span class="inputLabel">Proficiencies, Languages, and Talents</span>
			</div>
		</div>
		{% endif %}
		{% if variables.features_and_traits|default != "" %}
		<div class="col-12 col-md-12 col-lg-12">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.features_and_traits|nl2br }}</div><br>
				<span class="inputLabel">Features &amp; Traits</span>
			</div>
        </div>
		{% endif %}
		{% if sca != "NONE" %}
			{% if variables.spellcasting|default != "" %}
			<div class="col-12 col-md-12 col-lg-12 of">
				<div class="contentContainer contentContainer-standard of">
					<div class="pd">{{ variables.spellcasting|nl2br }}</div>
					{% if variables.half_caster is defined and variables.half_caster == '1' %}<br><br>Half-Rate Progression<br>{% endif %}
					<span class="inputLabel">Spellcasting</span>
				</div>
			</div>
			{% endif %}
		{% endif %}
		{% if variables.backstory|default != "" %}
		<div class="col-12 col-md-6 col-lg-6">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.backstory|nl2br }}</div><br>
				<span class="inputLabel">Backstory</span>
			</div>
		</div>
		{% endif %}
		{% if variables.allies|default != "" %}
		<div class="col-12 col-md-6 col-lg-6">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.allies|nl2br }}</div><br>
				<span class="inputLabel">Allies &amp; Organizations</span>
			</div>
        </div>
		{% endif %}
		{% if variables.motivation|default != "" %}
		<div class="col-12 col-md-6 col-lg-6">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.motivation|nl2br }}</div><br>
				<span class="inputLabel">Adventuring Motivation</span>
			</div>
        </div>
		{% endif %}
	</div>			
	{% if variables.notes|default != "" %}
	<div class="row">
		<div class="col-12 col-md-12">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.notes|nl2br }}</div><br>
				<span class="inputLabel">Notes</span>
			</div>
		</div>
	</div>			
	{% endif %}
	<div class="row">
		{% if variables.title1 is defined and variables.title1 != "" and variables.custom1 is defined %}
		<div class="col-12 col-md-12">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.custom1|nl2br }}</div><br>
				<span class="inputLabel">{{variables.title1}}</span>
			</div>
		</div>
		{% endif %}
		{% if variables.title2 is defined and variables.title2 != "" and variables.custom2 is defined %}
		<div class="col-12 col-md-12">
			<div class="contentContainer contentContainer-standard of">
				<div class="pd">{{ variables.custom2|nl2br }}</div><br>
				<span class="inputLabel">{{variables.title2}}</span>
			</div>
		</div>
		{% endif %}
	</div>			
    <div class="row do-not-print">
        <div class="col-12 text-center small">
				<br><br>
                &copy; Kobold Press - <a href="/w/sheet-creation/a/sheet-list">Tales of the Valiant Character Sheet v1.00</a>, made by Tillerz - <a href="/w/sheet-creation/thread/a85ac181-b0e3-4c85-a636-096853b46c58/view">Updated: 2023-05-25 - Changelog</a><br>
To print this sheet: Expand the spell book (if you have any entries there), then click "Print Sheet" at the top, select "Print to PDF" and format A3. Then print the resulting PDF to whichever format you need with "fit to page" selected.
        </div>
    </div>
</div>